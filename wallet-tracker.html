<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Orbital Forge | Sentinel Validator Delegation Explorer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Reuse your main site styles -->
  <link rel="stylesheet" href="assets/styles.css" />

  <style>
    .page-header {
      padding: 3rem 0 1.5rem;
      border-bottom: 1px solid var(--border-subtle);
      background: radial-gradient(circle at top, rgba(56,189,248,0.18), transparent 55%);
    }

    .page-header h1 {
      font-size: 2.1rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text-main);
      margin: 0 0 0.75rem;
    }

    .page-header .eyebrow {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }

    .page-header p {
      max-width: 680px;
      color: var(--text-muted);
      font-size: 0.95rem;
    }

    .validator-selector {
      margin-top: 1.5rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
    }

    .validator-selector label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-muted);
    }

    .validator-selector select,
    .validator-selector input {
      min-width: 240px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.95);
      color: var(--text-main);
      padding: 0.4rem 0.8rem;
      font-size: 0.82rem;
    }

    .validator-selector input {
      min-width: 280px;
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .validator-selector .btn-ghost {
      margin-left: 0.25rem;
    }

    .leaderboard-card,
    .foundation-card,
    .activity-card {
      margin-top: 2rem;
      background: var(--bg-elevated);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      padding: 1.5rem 1.5rem 1.25rem;
      box-shadow: 0 22px 60px rgba(15,23,42,0.75);
    }

    .leaderboard-header,
    .foundation-header,
    .activity-header {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .leaderboard-meta,
    .foundation-meta,
    .activity-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      font-size: 0.8rem;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.25rem 0.7rem;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      background: rgba(15,23,42,0.8);
      color: var(--text-muted);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      white-space: nowrap;
    }

    .pill strong {
      color: var(--text-main);
      font-weight: 500;
    }

    .pill--accent {
      border-color: rgba(56,189,248,0.7);
      background: var(--primary-soft);
      color: var(--primary);
    }

    .pill--warning {
      border-color: rgba(249,115,22,0.7);
      background: rgba(249,115,22,0.12);
      color: var(--warning);
    }

    .leaderboard-actions,
    .foundation-actions,
    .activity-actions {
      display: flex;
      gap: 0.75rem;
    }

    .btn-ghost {
      border-radius: var(--radius-pill);
      padding: 0.45rem 0.9rem;
      border: 1px solid rgba(148,163,184,0.5);
      background: rgba(15,23,42,0.9);
      color: var(--text-muted);
      font-size: 0.8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      transition: all 0.16s ease-out;
    }

    .btn-ghost:hover {
      border-color: rgba(56,189,248,0.7);
      color: var(--primary);
      transform: translateY(-1px);
    }

    .status-message {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin: 0.25rem 0 0.75rem;
      min-height: 1.2em;
    }

    .status-message--error {
      color: #fca5a5;
    }

    .leaderboard-table-wrapper,
    .foundation-table-wrapper,
    .activity-table-wrapper {
      width: 100%;
      overflow-x: auto;
      margin-top: 0.75rem;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,0.9);
      background: radial-gradient(circle at top left, rgba(56,189,248,0.06), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(99,102,241,0.06), transparent 55%),
                  rgba(15,23,42,0.9);
    }

    table.leaderboard-table,
    table.foundation-table,
    table.activity-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.86rem;
    }

    thead {
      background: rgba(15,23,42,0.96);
    }

    th,
    td {
      padding: 0.6rem 0.9rem;
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-muted);
      border-bottom: 1px solid rgba(148,163,184,0.35);
    }

    tbody tr {
      border-bottom: 1px solid rgba(15,23,42,0.96);
      transition: background 0.12s ease-out, transform 0.08s ease-out;
    }

    tbody tr:hover {
      background: rgba(15,23,42,0.9);
      transform: translateY(-1px);
    }

    td {
      color: var(--text-main);
    }

    .rank-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 1.7rem;
      height: 1.7rem;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.55);
      font-size: 0.78rem;
      font-weight: 500;
      color: var(--text-muted);
      background: radial-gradient(circle at top, rgba(15,23,42,0.9), rgba(15,23,42,0.95));
    }

    .rank-badge--gold {
      border-color: rgba(250,204,21,0.9);
      background: radial-gradient(circle at top, rgba(250,204,21,0.12), rgba(15,23,42,0.96));
      color: #facc15;
    }

    .rank-badge--silver {
      border-color: rgba(148,163,184,0.9);
      background: radial-gradient(circle at top, rgba(148,163,184,0.16), rgba(15,23,42,0.96));
      color: #e5e7eb;
    }

    .rank-badge--bronze {
      border-color: rgba(248,113,113,0.9);
      background: radial-gradient(circle at top, rgba(248,113,113,0.16), rgba(15,23,42,0.96));
      color: #fed7aa;
    }

    .address-mono {
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .address-mono strong {
      color: var(--text-main);
    }

    .tag-foundation {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.16rem 0.6rem;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .tag-foundation-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
    }

    .cell-right {
      text-align: right;
    }

    .muted {
      color: var(--text-muted);
      font-size: 0.78rem;
    }

    .current-validator-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 0.15rem;
    }

    .current-validator-label strong {
      color: var(--text-main);
    }

    .activity-wallet-filter {
      min-width: 220px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.95);
      color: var(--text-main);
      padding: 0.4rem 0.8rem;
      font-size: 0.82rem;
    }

    .tx-hash-link {
      font-size: 0.78rem;
      text-decoration: none;
      color: var(--accent);
    }

    .tx-hash-link span {
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    @media (max-width: 720px) {
      .leaderboard-header,
      .foundation-header,
      .activity-header {
        align-items: flex-start;
      }
      .leaderboard-actions,
      .foundation-actions,
      .activity-actions {
        width: 100%;
        justify-content: flex-start;
      }
      .validator-selector {
        align-items: flex-start;
      }
    }
  </style>
</head>

<body>
  <div class="page">

    <!-- NAVBAR -->
    <header class="site-header">
      <div class="container">
        <nav class="nav">
          <a href="index.html" class="brand">
            <img src="assets/orbitalforge-logo.png" class="brand-logo" alt="Orbital Forge logo" />
            <div class="brand-wordmark">
              <span class="brand-name">Orbital Forge</span>
              <span class="brand-tagline">Blockchain Infrastructure</span>
            </div>
          </a>
          <div class="nav-links">
            <a href="index.html">Home</a>
            <a href="validator.html">The Expanse Validator</a>
            <a href="wallet-tracker.html" class="nav-active">Wallet Tracker</a>
            <a href="index.html#tooling">Tooling</a>
            <a href="index.html#contact">Contact</a>
          </div>
        </nav>
      </div>
    </header>

    <!-- CONTENT -->
    <main>
      <!-- Header -->
      <section class="page-header">
        <div class="container">
          <div class="eyebrow">Sentinel Network · Community Tooling</div>
          <h1>Validator Delegation Explorer</h1>
          <p>
            Explore delegation distribution for any active validator in the Sentinel set, and view
            the current state and activity of designated <strong>community wallets</strong>. Built by
            <strong>Orbital Forge</strong> to support validators and delegators across the network.
          </p>

          <!-- Validator selector -->
          <div class="validator-selector">
            <div style="display:flex;flex-direction:column;gap:0.25rem;">
              <label for="validator-select">Active validators</label>
              <select id="validator-select">
                <option value="">Loading validators…</option>
              </select>
              <span id="current-validator-label" class="current-validator-label">
                Current validator: <strong>–</strong>
              </span>
            </div>

            <div style="display:flex;flex-direction:column;gap:0.25rem;">
              <label for="valoper-input">Or paste a valoper address</label>
              <div style="display:flex;gap:0.5rem;flex-wrap:wrap;align-items:center;">
                <input
                  id="valoper-input"
                  type="text"
                  placeholder="sentvaloper1..."
                  autocomplete="off"
                  spellcheck="false"
                />
                <button id="apply-valoper-button" class="btn-ghost" type="button">
                  <span>✓</span>
                  <span>Use validator</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Community Wallets -->
      <section class="section">
        <div class="container">
          <div class="foundation-card">
            <div class="foundation-header">
              <div>
                <h2 style="font-size:1.1rem;margin:0 0 0.25rem;">Community Wallets Overview</h2>
                <p class="muted" style="margin:0;">
                  These wallets are tracked explicitly, even if they are not currently delegating to
                  a specific validator. Balances shown are liquid P2P (bank balances), not including staked P2P.
                  Each wallet is labeled by type (for example: Foundation, DAO, Grants, Community Pool).
                </p>
              </div>
              <div class="foundation-actions">
                <button id="foundation-refresh-button" class="btn-ghost" type="button">
                  <span>↻</span>
                  <span>Refresh</span>
                </button>
              </div>
            </div>

            <p id="foundation-status-message" class="status-message">
              Fetching community wallet balances…
            </p>

            <div class="foundation-table-wrapper">
              <table class="foundation-table">
                <thead>
                  <tr>
                    <th>Wallet</th>
                    <th>Type</th>
                    <th class="cell-right">Liquid P2P</th>
                  </tr>
                </thead>
                <tbody id="foundation-body">
                  <!-- Filled by JS -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Community Wallet Activity -->
      <section class="section">
        <div class="container">
          <div class="activity-card">
            <div class="activity-header">
              <div>
                <h2 style="font-size:1.05rem;margin:0 0 0.25rem;">Community Wallet Activity</h2>
                <p class="muted" style="margin:0;">
                  Recent outgoing transactions from tracked community wallets. This focuses on P2P bank
                  sends (MsgSend) and shows destination addresses and amounts.
                </p>
              </div>
              <div class="activity-actions">
                <select id="activity-wallet-select" class="activity-wallet-filter">
                  <option value="__all__">All community wallets</option>
                </select>
                <button id="activity-refresh-button" class="btn-ghost" type="button">
                  <span>↻</span>
                  <span>Refresh</span>
                </button>
              </div>
            </div>

            <p id="activity-status-message" class="status-message">
              Fetching recent transactions for community wallets…
            </p>

            <div class="activity-table-wrapper">
              <table class="activity-table">
                <thead>
                  <tr>
                    <th>Time (UTC)</th>
                    <th>From</th>
                    <th>To</th>
                    <th class="cell-right">Amount P2P</th>
                    <th>Tx Hash</th>
                  </tr>
                </thead>
                <tbody id="activity-body">
                  <!-- Filled by JS -->
                </tbody>
              </table>
            </div>

            <p class="muted" style="margin-top:0.6rem;">
              Data is pulled from the Sentinel LCD transaction API. Only outgoing MsgSend transfers in P2P
              are shown. Some historical transactions may not appear if API pagination limits are reached.
            </p>
          </div>
        </div>
      </section>

      <!-- Delegation Leaderboard -->
      <section class="section">
        <div class="container">
          <div class="leaderboard-card">
            <div class="leaderboard-header">
              <div class="leaderboard-meta">
                <span class="pill pill--accent">
                  Total Delegated:
                  <strong id="total-delegated">–</strong>
                  <span class="muted">P2P</span>
                </span>
                <span class="pill">
                  Delegators:
                  <strong id="delegator-count">–</strong>
                </span>
                <span class="pill pill--warning">
                  Commission:
                  <strong id="commission-rate">–</strong>
                </span>
              </div>

              <div class="leaderboard-actions">
                <button id="refresh-button" class="btn-ghost" type="button">
                  <span>↻</span>
                  <span>Refresh</span>
                </button>
                <a id="explorer-link" class="btn-ghost" href="https://explorer.sentinel.co/validators" target="_blank" rel="noopener">
                  <span>↗</span>
                  <span>View on Explorer</span>
                </a>
              </div>
            </div>

            <p id="status-message" class="status-message">
              Select a validator to load its delegations.
            </p>

            <div class="leaderboard-table-wrapper">
              <table class="leaderboard-table">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Wallet</th>
                    <th class="cell-right">Delegated P2P</th>
                    <th class="cell-right">% of Validator Stake</th>
                    <th>Tags</th>
                  </tr>
                </thead>
                <tbody id="leaderboard-body">
                  <!-- rows inserted by JS -->
                </tbody>
              </table>
            </div>

            <p class="muted" style="margin-top: 0.6rem;">
              Values are approximate and based on on-chain staking data. Smaller delegations may be
              truncated if the API pagination limit is reached.
            </p>
          </div>
        </div>
      </section>
    </main>

    <!-- FOOTER -->
    <footer class="site-footer">
      <div class="container footer-inner">
        <div class="footer-left">
          <span class="footer-brand">Orbital Forge</span>
          <span class="footer-copy">© <span id="year"></span> Orbital Forge LLC · All rights reserved.</span>
        </div>
        <div class="footer-links">
          <a href="https://github.com/orbital-forge" target="_blank" rel="noopener">GitHub</a>
          <a href="https://explorer.sentinel.co" target="_blank" rel="noopener">Sentinel Explorer</a>
        </div>
      </div>
    </footer>

  </div>

  <script>
    // ========= CONFIG =========

    const LCD_BASE = "https://lcd.sentinel.co";
    const DVPN_DENOM = "udvpn";
    const DVPN_EXPONENT = 6;
    const TXS_PER_WALLET_LIMIT = 50; // how many txs to pull per wallet for activity view

    // Community wallets (any label you want: Foundation, DAO, Grants, etc.)
    const COMMUNITY_WALLETS = [
      {
        address: "sent1t7f57wx8lfm8y4eeq5vk2cf5cnsq5d7264rstt",
        label: "DAO"
      },
      {
        address: "sent1p3hta793yukw9p3hfwct0gdnzzf7vvvwwdys3z",
        label: "Multisig Community Funds"
      }
      // Add more like:
      // { address: "sent1xxxx...", label: "Foundation" },
      // { address: "sent1yyyy...", label: "Grants" }
    ];

    // Initial validator (optional) – if you want the page to default to The Expanse, put your valoper here.
    const DEFAULT_VALOPER = ""; // e.g. "sentvaloper1xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"

    let currentValoper = DEFAULT_VALOPER || null;
    let currentValidatorMeta = null;
    let validatorsIndex = []; // Array of {operator_address, moniker}

    // ========= HELPERS =========

    function formatDvpnFromBase(amountStr) {
      const num = Number(amountStr || "0");
      const dvpn = num / Math.pow(10, DVPN_EXPONENT);
      return dvpn.toLocaleString(undefined, {
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
      });
    }

    function abbreviateAddress(addr) {
      if (!addr || addr.length <= 12) return addr || "";
      return addr.slice(0, 7) + "…" + addr.slice(-5);
    }

    function setStatus(id, message, isError = false) {
      const el = document.getElementById(id);
      if (!el) return;
      el.textContent = message;
      el.classList.toggle("status-message--error", !!isError);
    }

    function setTotals(totalDelegated, count) {
      const totalEl = document.getElementById("total-delegated");
      const countEl = document.getElementById("delegator-count");
      if (totalEl) totalEl.textContent = totalDelegated.toLocaleString(undefined, {
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
      });
      if (countEl) countEl.textContent = count.toString();
    }

    function setCommissionDisplay(rateStr) {
      const el = document.getElementById("commission-rate");
      if (!el) return;
      if (!rateStr && rateStr !== "0") {
        el.textContent = "–";
        return;
      }
      const pct = Number(rateStr) * 100;
      el.textContent = pct.toFixed(2) + " %";
    }

    function applyRankClass(rank) {
      if (rank === 1) return "rank-badge rank-badge--gold";
      if (rank === 2) return "rank-badge rank-badge--silver";
      if (rank === 3) return "rank-badge rank-badge--bronze";
      return "rank-badge";
    }

    function getCommunityWalletMeta(addr) {
      if (!addr) return null;
      const trimmed = addr.trim();
      return COMMUNITY_WALLETS.find(w => (w.address || "").trim() === trimmed) || null;
    }

    function updateCurrentValidatorLabel() {
      const labelEl = document.getElementById("current-validator-label");
      if (!labelEl) return;
      const strongEl = labelEl.querySelector("strong");
      const name = currentValidatorMeta?.description?.moniker || (currentValoper || "–");
      if (strongEl) strongEl.textContent = name;
    }

    function updateExplorerLink() {
      const link = document.getElementById("explorer-link");
      if (!link) return;
      if (!currentValoper) {
        link.href = "https://explorer.sentinel.co/validators";
        return;
      }
      // If you have a specific explorer URL pattern for valoper, plug it in here.
      link.href = "https://explorer.sentinel.co/validators/" + currentValoper;
    }

    function formatTimestamp(ts) {
      if (!ts) return "–";
      const d = new Date(ts);
      if (Number.isNaN(d.getTime())) return ts;
      return d.toISOString().replace("T", " ").replace("Z", "");
    }

    // ========= VALIDATOR LIST & META =========

    async function loadValidatorSet() {
      const select = document.getElementById("validator-select");
      if (!select) return;

      select.innerHTML = "<option value=\"\">Loading validators…</option>";

      try {
        const url = new URL("/cosmos/staking/v1beta1/validators", LCD_BASE);
        url.searchParams.set("status", "BOND_STATUS_BONDED");
        url.searchParams.set("pagination.limit", "80");
        const res = await fetch(url.toString());
        if (!res.ok) {
          console.error("Error loading validator set", res.status, await res.text());
          throw new Error("LCD returned " + res.status);
        }
        const data = await res.json();
        const vals = data.validators || [];

        validatorsIndex = vals.map(v => ({
          operator_address: v.operator_address,
          moniker: v.description?.moniker || v.operator_address
        }));

        // Populate dropdown
        select.innerHTML = "";
        select.appendChild(new Option("Select a validator…", "", true, false));
        validatorsIndex.forEach(v => {
          const label = `${v.moniker} (${abbreviateAddress(v.operator_address)})`;
          const opt = new Option(label, v.operator_address, false, false);
          select.appendChild(opt);
        });

        // If DEFAULT_VALOPER is set, pre-select it
        if (currentValoper) {
          const found = validatorsIndex.find(v => v.operator_address === currentValoper);
          if (found) {
            select.value = currentValoper;
          }
        }
      } catch (err) {
        console.error(err);
        select.innerHTML = "<option value=\"\">Failed to load validators</option>";
      }
    }

    async function loadValidatorMeta(valoper) {
      if (!valoper) {
        currentValidatorMeta = null;
        setCommissionDisplay(null);
        updateCurrentValidatorLabel();
        return;
      }

      try {
        const url = new URL(`/cosmos/staking/v1beta1/validators/${valoper}`, LCD_BASE);
        const res = await fetch(url.toString());
        if (!res.ok) {
          console.error("Validator meta error", res.status, await res.text());
          throw new Error("LCD returned " + res.status);
        }
        const data = await res.json();
        currentValidatorMeta = data.validator || null;
        const rate = currentValidatorMeta?.commission?.commission_rates?.rate;
        setCommissionDisplay(rate);
      } catch (err) {
        console.error(err);
        currentValidatorMeta = null;
        setCommissionDisplay(null);
      }

      updateCurrentValidatorLabel();
    }

    async function setCurrentValidator(valoper) {
      currentValoper = valoper || null;
      updateCurrentValidatorLabel();
      updateExplorerLink();

      const tbody = document.getElementById("leaderboard-body");
      if (tbody) tbody.innerHTML = "";

      if (!currentValoper) {
        setStatus("status-message", "Select a validator to load its delegations.", false);
        setTotals(0, 0);
        setCommissionDisplay(null);
        return;
      }

      await loadValidatorMeta(currentValoper);
      await refreshLeaderboard();
    }

    // ========= DELEGATION DATA (LEADERBOARD) =========

    async function fetchAllDelegations() {
      if (!currentValoper) {
        throw new Error("No validator selected.");
      }

      let nextKey = null;
      const all = [];
      let page = 0;
      const limit = 200;

      do {
        page += 1;
        const url = new URL(
          `/cosmos/staking/v1beta1/validators/${currentValoper}/delegations`,
          LCD_BASE
        );
        url.searchParams.set("pagination.limit", String(limit));
        if (nextKey) {
          url.searchParams.set("pagination.key", nextKey);
        }

        const res = await fetch(url.toString());
        if (!res.ok) {
          console.error("LCD error", res.status, await res.text());
          throw new Error(`LCD returned HTTP ${res.status}`);
        }

        const data = await res.json();
        const responses = data.delegation_responses || [];
        all.push(...responses);

        const pag = data.pagination || {};
        nextKey = pag.next_key && pag.next_key.length ? pag.next_key : null;

        if (page > 25) {
          console.warn("Pagination exceeded 25 pages, stopping early for safety.");
          nextKey = null;
        }
      } while (nextKey);

      return all;
    }

    function buildLeaderboard(delegationResponses) {
      const tbody = document.getElementById("leaderboard-body");
      if (!tbody) return;

      tbody.innerHTML = "";

      if (!delegationResponses || delegationResponses.length === 0) {
        setStatus("status-message", "No delegations found for this validator.", false);
        setTotals(0, 0);
        return;
      }

      const byDelegator = new Map();

      for (const resp of delegationResponses) {
        const delegation = resp.delegation || {};
        const balance = resp.balance || {};
        const addr = delegation.delegator_address;
        const amountStr = balance.amount || "0";
        if (!addr) continue;

        const prev = byDelegator.get(addr) || 0;
        const next = prev + Number(amountStr);
        byDelegator.set(addr, next);
      }

      let totalBase = 0;
      const rows = [];

      for (const [addr, baseAmount] of byDelegator.entries()) {
        totalBase += baseAmount;
        rows.push({ address: addr, baseAmount });
      }

      rows.sort((a, b) => b.baseAmount - a.baseAmount);

      const totalDvpn = totalBase / Math.pow(10, DVPN_EXPONENT);
      setTotals(totalDvpn, rows.length);

      rows.forEach((row, idx) => {
        const rank = idx + 1;
        const pct = totalBase > 0 ? (row.baseAmount / totalBase) * 100 : 0;
        const communityMeta = getCommunityWalletMeta(row.address);

        const tr = document.createElement("tr");

        const rankTd = document.createElement("td");
        const badge = document.createElement("span");
        badge.className = applyRankClass(rank);
        badge.textContent = rank;
        rankTd.appendChild(badge);
        tr.appendChild(rankTd);

        const walletTd = document.createElement("td");
        const addrSpan = document.createElement("span");
        addrSpan.className = "address-mono";
        addrSpan.innerHTML = `<strong>${abbreviateAddress(row.address)}</strong>`;
        walletTd.appendChild(addrSpan);
        tr.appendChild(walletTd);

        const dvpnTd = document.createElement("td");
        dvpnTd.className = "cell-right";
        dvpnTd.textContent = formatDvpnFromBase(String(row.baseAmount));
        tr.appendChild(dvpnTd);

        const pctTd = document.createElement("td");
        pctTd.className = "cell-right muted";
        pctTd.textContent = pct.toFixed(3) + " %";
        tr.appendChild(pctTd);

        const tagTd = document.createElement("td");
        if (communityMeta) {
          const tag = document.createElement("span");
          tag.className = "tag-foundation";
          tag.innerHTML = `<span class="tag-foundation-dot"></span> ${communityMeta.label}`;
          tagTd.appendChild(tag);
        } else if (rank <= 3) {
          const tag = document.createElement("span");
          tag.className = "muted";
          tag.textContent = "Top supporter";
          tagTd.appendChild(tag);
        } else {
          tagTd.innerHTML = "&nbsp;";
        }
        tr.appendChild(tagTd);

        tbody.appendChild(tr);
      });

      setStatus("status-message", `Loaded ${rows.length} delegators from Sentinel LCD.`, false);
    }

    async function refreshLeaderboard() {
      try {
        if (!currentValoper) {
          setStatus("status-message", "Select a validator to load its delegations.", false);
          return;
        }
        setStatus("status-message", "Fetching delegations from Sentinel LCD…", false);
        const responses = await fetchAllDelegations();
        buildLeaderboard(responses);
      } catch (err) {
        console.error(err);
        setStatus("status-message", "Failed to load delegations. LCD may be unreachable or CORS-blocked. Try again later.", true);
      }
    }

    // ========= COMMUNITY WALLET BALANCES =========

    async function fetchCommunityBalance(address) {
      const url = new URL(`/cosmos/bank/v1beta1/balances/${address}`, LCD_BASE);
      const res = await fetch(url.toString());
      if (!res.ok) {
        console.error("Bank LCD error", res.status, await res.text());
        throw new Error(`bank LCD returned HTTP ${res.status} for ${address}`);
      }
      const data = await res.json();
      const balances = data.balances || [];
      const dvpnBalance = balances.find(b => b.denom === DVPN_DENOM);
      return {
        address,
        baseAmount: dvpnBalance ? Number(dvpnBalance.amount || "0") : 0
      };
    }

    async function refreshFoundationWallets() {
      const tbody = document.getElementById("foundation-body");
      if (!tbody) return;

      tbody.innerHTML = "";

      if (!COMMUNITY_WALLETS || COMMUNITY_WALLETS.length === 0) {
        setStatus("foundation-status-message", "No community wallets configured. Add them in the script to see their balances.", false);
        return;
      }

      setStatus("foundation-status-message", "Fetching community wallet balances…", false);

      for (const entry of COMMUNITY_WALLETS) {
        const cleanAddr = (entry.address || "").trim();
        const label = entry.label || "Community";
        if (!cleanAddr) continue;

        const tr = document.createElement("tr");

        const walletTd = document.createElement("td");
        walletTd.className = "address-mono";
        walletTd.innerHTML = `<strong>${abbreviateAddress(cleanAddr)}</strong>`;
        tr.appendChild(walletTd);

        const typeTd = document.createElement("td");
        typeTd.className = "muted";
        typeTd.textContent = label;
        tr.appendChild(typeTd);

        const balTd = document.createElement("td");
        balTd.className = "cell-right";
        balTd.textContent = "Loading…";
        tr.appendChild(balTd);

        tbody.appendChild(tr);

        try {
          const res = await fetchCommunityBalance(cleanAddr);
          balTd.textContent = formatDvpnFromBase(String(res.baseAmount));
        } catch (err) {
          console.error(err);
          balTd.textContent = "Error";
          balTd.classList.add("muted");
        }
      }

      setStatus("foundation-status-message", "Community wallet balances updated.", false);
    }

    // ========= COMMUNITY WALLET ACTIVITY (TX HISTORY) =========

    async function fetchWalletTxs(address) {
      const url = new URL("/cosmos/tx/v1beta1/txs", LCD_BASE);
      url.searchParams.set("events", `message.sender='${address}'`);
      // Use numeric enum value for DESC (2) instead of string name
      url.searchParams.set("order_by", "2");
      url.searchParams.set("pagination.limit", String(TXS_PER_WALLET_LIMIT));
    
      const res = await fetch(url.toString());
      if (!res.ok) {
        console.error("TX LCD error", res.status, await res.text());
        throw new Error(`tx LCD returned HTTP ${res.status} for ${address}`);
      }
    
      const data = await res.json();
      const txs = data.txs || [];
      const responses = data.tx_responses || [];
    
      const rows = [];
    
      for (let i = 0; i < txs.length; i++) {
        const tx = txs[i];
        const resp = responses[i] || {};
        const msgs = tx.body?.messages || [];
        const ts = resp.timestamp;
        const txhash = resp.txhash;
    
        for (const msg of msgs) {
          const type = msg["@type"] || msg.type_url || "";
          if (!type.includes("cosmos.bank.v1beta1.MsgSend")) continue;
    
          if (msg.from_address !== address) continue; // only outgoing
    
          const to = msg.to_address;
          const amounts = msg.amount || [];
          for (const coin of amounts) {
            if (coin.denom !== DVPN_DENOM) continue;
            rows.push({
              from: address,
              to,
              baseAmount: Number(coin.amount || "0"),
              timestamp: ts,
              txhash
            });
          }
        }
      }
    
      return rows;
    }


    function buildActivityTable(rows) {
      const tbody = document.getElementById("activity-body");
      if (!tbody) return;
      tbody.innerHTML = "";

      if (!rows || rows.length === 0) {
        setStatus("activity-status-message", "No recent outgoing P2P transfers found for the selected scope.", false);
        return;
      }

      rows.forEach(row => {
        const meta = getCommunityWalletMeta(row.from);
        const tr = document.createElement("tr");

        const timeTd = document.createElement("td");
        timeTd.className = "muted";
        timeTd.textContent = formatTimestamp(row.timestamp);
        tr.appendChild(timeTd);

        const fromTd = document.createElement("td");
        fromTd.className = "address-mono";
        const label = meta?.label ? meta.label + " · " : "";
        fromTd.innerHTML = `<strong>${label}${abbreviateAddress(row.from)}</strong>`;
        tr.appendChild(fromTd);

        const toTd = document.createElement("td");
        toTd.className = "address-mono";
        toTd.innerHTML = `<strong>${abbreviateAddress(row.to)}</strong>`;
        tr.appendChild(toTd);

        const amtTd = document.createElement("td");
        amtTd.className = "cell-right";
        amtTd.textContent = formatDvpnFromBase(String(row.baseAmount));
        tr.appendChild(amtTd);

        const hashTd = document.createElement("td");
        const a = document.createElement("a");
        a.className = "tx-hash-link";
        a.href = row.txhash
          ? `https://explorer.sentinel.co/transactions/${row.txhash}`
          : "#";
        a.target = "_blank";
        a.rel = "noopener";
        a.innerHTML = `<span>${row.txhash ? abbreviateAddress(row.txhash) : "–"}</span> ↗`;
        hashTd.appendChild(a);
        tr.appendChild(hashTd);

        tbody.appendChild(tr);
      });

      setStatus("activity-status-message", `Showing ${rows.length} recent outgoing P2P transfers.`, false);
    }

    async function refreshCommunityActivity() {
      const tbody = document.getElementById("activity-body");
      if (tbody) tbody.innerHTML = "";

      if (!COMMUNITY_WALLETS || COMMUNITY_WALLETS.length === 0) {
        setStatus("activity-status-message", "No community wallets configured. Add them in the script to see their activity.", false);
        return;
      }

      const select = document.getElementById("activity-wallet-select");
      const scope = select?.value || "__all__";

      if (scope === "__all__") {
        setStatus("activity-status-message", "Fetching recent transactions for all community wallets…", false);
      } else {
        const meta = getCommunityWalletMeta(scope);
        const label = meta?.label || "community wallet";
        setStatus("activity-status-message", `Fetching recent transactions for ${label}…`, false);
      }

      try {
        let rows = [];

        if (scope === "__all__") {
          const promises = COMMUNITY_WALLETS.map(w =>
            fetchWalletTxs(w.address).catch(err => {
              console.error("Error fetching txs for", w.address, err);
              return [];
            })
          );
          const allResults = await Promise.all(promises);
          allResults.forEach(r => rows.push(...r));
        } else {
          rows = await fetchWalletTxs(scope);
        }

        // Sort by timestamp desc
        rows.sort((a, b) => {
          const ta = new Date(a.timestamp || 0).getTime();
          const tb = new Date(b.timestamp || 0).getTime();
          return tb - ta;
        });

        buildActivityTable(rows);
      } catch (err) {
        console.error(err);
        setStatus(
          "activity-status-message",
          "Failed to load activity. LCD may be unreachable or CORS-blocked. Try again later.",
          true
        );
      }
    }

    function populateActivityWalletSelect() {
      const select = document.getElementById("activity-wallet-select");
      if (!select) return;
      select.innerHTML = "";
      select.appendChild(new Option("All community wallets", "__all__", true, true));
      COMMUNITY_WALLETS.forEach(w => {
        const label = w.label ? `${w.label} (${abbreviateAddress(w.address)})` : abbreviateAddress(w.address);
        const opt = new Option(label, w.address, false, false);
        select.appendChild(opt);
      });
    }

    // ========= INIT =========

    document.addEventListener("DOMContentLoaded", () => {
      const yearEl = document.getElementById("year");
      if (yearEl) yearEl.textContent = new Date().getFullYear();

      const refreshBtn = document.getElementById("refresh-button");
      if (refreshBtn) {
        refreshBtn.addEventListener("click", () => {
          refreshLeaderboard();
        });
      }

      const fRefreshBtn = document.getElementById("foundation-refresh-button");
      if (fRefreshBtn) {
        fRefreshBtn.addEventListener("click", () => {
          refreshFoundationWallets();
        });
      }

      const activityRefreshBtn = document.getElementById("activity-refresh-button");
      if (activityRefreshBtn) {
        activityRefreshBtn.addEventListener("click", () => {
          refreshCommunityActivity();
        });
      }

      const activityWalletSelect = document.getElementById("activity-wallet-select");
      if (activityWalletSelect) {
        activityWalletSelect.addEventListener("change", () => {
          refreshCommunityActivity();
        });
      }

      const selectEl = document.getElementById("validator-select");
      if (selectEl) {
        selectEl.addEventListener("change", async (e) => {
          const valoper = e.target.value || null;
          const input = document.getElementById("valoper-input");
          if (input && valoper) {
            input.value = valoper;
          }
          await setCurrentValidator(valoper);
        });
      }

      const applyBtn = document.getElementById("apply-valoper-button");
      if (applyBtn) {
        applyBtn.addEventListener("click", async () => {
          const input = document.getElementById("valoper-input");
          const valoper = (input?.value || "").trim();
          if (!valoper) return;
          if (selectEl) {
            // Try to sync dropdown to this valoper if it exists
            const option = Array.from(selectEl.options).find(o => o.value === valoper);
            if (option) selectEl.value = valoper;
            else selectEl.value = "";
          }
          await setCurrentValidator(valoper);
        });
      }

      loadValidatorSet();
      refreshFoundationWallets();
      populateActivityWalletSelect();
      refreshCommunityActivity();

      // If you set DEFAULT_VALOPER, pre-load it
      if (DEFAULT_VALOPER) {
        const input = document.getElementById("valoper-input");
        if (input) input.value = DEFAULT_VALOPER;
        setCurrentValidator(DEFAULT_VALOPER);
      } else {
        updateCurrentValidatorLabel();
        updateExplorerLink();
      }
    });
  </script>
</body>
</html>
